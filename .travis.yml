language: php

services:
    - mysql

env:
    global:
        - SIMPLETEST_DB="mysql://root:@127.0.0.1/drupal"
php:
    - 7.2

cache:
    - "$HOME/.composer/cache"

matrix:
    fast_finish: true

mysql:
    database: drupal
    username: root
    encoding: utf8

before_install:
    - phpenv config-rm xdebug.ini || true
    - mysql -e 'CREATE DATABASE IF NOT EXISTS drupal CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci' -uroot
    - sed -i '1i export PATH="$HOME/.composer/vendor/bin:$PATH"' $HOME/.bashrc
    - source $HOME/.bashrc
    - composer self-update --1

install:
    - composer install
    - ./bin/robo build

script:
    - ./bin/robo lint:php
    - ./bin/phpunit --stop-on-failure --testsuite unit
    - ./bin/phpunit --stop-on-failure --testsuite unit
    - ./bin/phpunit --stop-on-failure --testsuite kernel
    - ./bin/phpunit --stop-on-failure --testsuite functional
    - ./bin/phpunit --stop-on-failure --testsuite functionaljs
    - ./bin/phpunit --stop-on-failure --testsuite functionalclean
