# Shepherd Gitlab CI script
shepherd:
  script:
    - eval `ssh-agent`
    - echo "${JENKINS_DEPLOYMENT_KEY}" > /tmp/jenkins_deployment_key
    - chmod 0600 /tmp/jenkins_deployment_key
    - ssh-add /tmp/jenkins_deployment_key
    - ssh-add -l
    - docker pull uofa/apache2-php7-dev:shepherd
    - docker pull mariadb
    - php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    - php -r "if (hash_file('SHA384', 'composer-setup.php') === '669656bab3166a7aff8a7506b8cb2d1c292f042046c5a994c43155c0be6190fa0355160742ab2e1c88d40d5be660b410') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
    - php composer-setup.php
    - php -r "unlink('composer-setup.php');"
    - php composer.phar install
    - ./dsh start
    - sleep 10
    - ./dsh exec $(basename ${CI_JOB_NAME} | sed 's/[-_]//g')_web_1 root 'chmod -R 777 /web/app/sites/default'
    # This is one big long command line passed to the utility container.
    - ./dsh exec bash -c '
        export GITLAB_CI=true &&
        export SIMPLETEST_DB=\'mysql://user:password@db/drupal\' &&
        cd /code &&
        mkdir -p ~/.ssh &&
        ssh-keyscan -H gitlab.adelaide.edu.au >> ~/.ssh/known_hosts &&
        sudo phpdismod xdebug && robo build &&
        ./bin/phpunit --group ua --testdox -c ./app/core ./app/modules';
  after_script:
    - ./dsh exec $(basename ${CI_JOB_NAME} | sed 's/[-_]//g')_web_1 root 'rm -rf /web/app/sites/default'
    - ./dsh purge
  tags:
  except:
  - tags
