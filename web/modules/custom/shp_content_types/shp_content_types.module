<?php

/**
 * @file
 * Contains shp_content_types.module.
 */

use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\node\NodeInterface;
use Drupal\node\Entity\Node;

/**
 * Implements hook_ENTITY_TYPE_presave().
 */
function shp_content_types_node_presave(NodeInterface $node) {
  if ($node->bundle() === 'shp_environment') {
    // Set title to new environment's domain/path.
    $node->setTitle($node->field_shp_domain->value . $node->field_shp_path->value);
  }
}

/**
 * Implements hook_entity_bundle_field_info_alter().
 */
function shp_content_types_entity_bundle_field_info_alter(&$fields, EntityTypeInterface $entity_type, $bundle) {
  if ($bundle === 'shp_site') {
    if (isset($fields['field_shp_domain'])) {
      $fields['field_shp_domain']->addConstraint('ComboUniqueField', ['fields' => ['field_shp_path']]);
      $fields['field_shp_domain']->addConstraint('Domain', []);
    }
    if (isset($fields['field_shp_path'])) {
      $fields['field_shp_path']->addConstraint('Path', []);
    }
    if (isset($fields['field_shp_short_name'])) {
      $fields['field_shp_short_name']->addConstraint('ComboUniqueField', ['fields' => ['field_shp_path']]);
    }
  }
  elseif ($bundle === 'shp_environment') {
    if (isset($fields['field_shp_domain'])) {
      $fields['field_shp_domain']->addConstraint('Domain', []);
    }
    if (isset($fields['field_shp_env_vars'])) {
      $fields['field_shp_env_vars']->addConstraint('EnvironmentVariableName',
        []);
    }
    if (isset($fields['field_shp_path'])) {
      $fields['field_shp_path']->addConstraint('Path', []);
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function shp_content_types_preprocess_page_title(&$variables) {
  $params = \Drupal::routeMatch()->getParameters();
  $views = [
    'shp_site_environments' => 'Environments',
    'shp_site_users'        => 'Users',
  ];

  if (in_array($params->get('view_id'), array_keys($views))) {
    $node = Node::load($params->get('node'));
    $site_title = $node->getTitle();
    // Sets the page title for site(s) pages.
    $variables['title']['#markup'] = $site_title . ' - ' . $views[$params->get('view_id')];
    // Get the url path.
  }
}

/**
 * Implements hook_ENTITY_TYPE_insert().
 */
function shp_content_types_node_insert(NodeInterface $node) {
  // @todo - use switch statement here.
  // @todo - on environment creation .. if flag is set to Production update the go-live field - if null.
  // @todo - when environment edited .. if flag is set to production update the go-live field - if null.
  $type = $node->getType();
  switch ($type) {
    case 'shp_site':
      \Drupal::service('shp_content_types.group_manager')->create($node);
      \Drupal::service('shp_content_types.group_manager')->addSiteToDistributionGroup($node);
      break;

    case 'shp_distribution':
      \Drupal::service('shp_content_types.group_manager')->create($node);
      break;

    case 'shp_environment':
      // get the parent
      $test = $node;
      break;

  }
}

function shp_content_types_node_update(NodeInterface $node) {
  $type = $node->getType();

  if ($type === "shp_environment") {
    $environment_type_taxonomy_id = $node->field_shp_environment_type->getString();
    if (isset($environment_type_taxonomy_id)) {
      $term = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->load($environment_type_taxonomy_id);
      if ($term->getName() === "Production") {
        // Load the parent entity and run the check.
        $site = Node::load($node->field_shp_site->getString());
        $go_live_date = $site->field_shp_go_live_date->value;
        if (isset($go_live_date)) {
          // @todo - create a date.
          $site->field_shp_go_live_date->setValue('');
        }

      }
    }

  }

}

/**
 * Implements hook_ENTITY_TYPE_delete().
 */
function shp_content_types_node_delete(NodeInterface $node) {
  if ($node->getType() === 'shp_site' || $node->getType() === 'shp_distribution') {
    \Drupal::service('shp_content_types.group_manager')->delete($node);
  }
}
