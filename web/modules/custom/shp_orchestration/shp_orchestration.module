<?php

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\shp_orchestration\Exception\OrchestrationProviderNotConfiguredException;

/**
 * Implements hook_ENTITY_TYPE_insert().
 */
function shp_orchestration_node_insert(EntityInterface $entity) {
  /** @var Drupal\node\Entity\Node $entity */
  $bundle = $entity->bundle();

  if (strpos($bundle, 'shp') !== FALSE) {
    try {
      /** @var Drupal\shp_orchestration\OrchestrationProviderInterface $orchestration_provider_plugin */
      $orchestration_provider_plugin = \Drupal::service('plugin.manager.orchestration_provider')
        ->getProviderInstance();
    }
    catch (OrchestrationProviderNotConfiguredException $e) {
      drupal_set_message($e->getMessage(), 'warning');
      return FALSE;
    }

    switch ($bundle) {
      case 'shp_distribution':
        $result = $orchestration_provider_plugin->createdDistribution(
          $entity->getTitle(),
          $entity->field_shp_builder_image->value,
          $entity->field_shp_git_repository->value,
          // @todo Consider fetching default source ref from config.
          'master',
          $entity->field_shp_build_secret->value
        );

        if (!$result) {
          return FALSE;
        }
        break;

      case 'shp_environment':

        if (isset($entity->field_shp_site->target_id)) {
          $site = $entity->get('field_shp_site')
            ->first()
            ->get('entity')
            ->getTarget()
            ->getValue();

          if (isset($site->field_shp_distribution->target_id)) {
            $distribution = $site->get('field_shp_distribution')
              ->first()
              ->get('entity')
              ->getTarget()
              ->getValue();
          }
        }
        if (!isset($distribution) || !isset($site)) {
          return FALSE;
        }

        $cron_jobs = [];
        foreach ($entity->field_shp_cron_jobs as $job) {
          $cron_jobs[$job->key] = $job->value;
        }

        // Collate environment variables and secrets.
        $env_vars = \Drupal::moduleHandler()->invokeAll('shp_env_vars', [$entity]);
        $secrets = \Drupal::moduleHandler()->invokeAll('shp_secrets', [$entity]);

        $result = $orchestration_provider_plugin->createdEnvironment(
          $distribution->getTitle(),
          $site->field_shp_short_name->value,
          $site->id(),
          $entity->id(),
          $entity->toUrl('canonical', ['absolute' => TRUE])->toString(),
          $distribution->field_shp_builder_image->value,
          $distribution->field_shp_git_repository->value,
          $entity->field_shp_git_reference->value,
          $distribution->field_shp_build_secret->value,
          $env_vars,
          $secrets,
          $cron_jobs
        );

        if (!$result) {
          return FALSE;
        }
        break;
    }
  }
  return TRUE;
}

/**
 * Implements hook_ENTITY_TYPE_update().
 */
function shp_orchestration_node_update(EntityInterface $entity) {
  $bundle = $entity->bundle();

  if (strpos($bundle, 'shp') !== FALSE) {
    try {
      /** @var Drupal\shp_orchestration\OrchestrationProviderInterface $orchestration_provider_plugin */
      $orchestration_provider_plugin = \Drupal::service('plugin.manager.orchestration_provider')
        ->getProviderInstance();
    }
    catch (OrchestrationProviderNotConfiguredException $e) {
      drupal_set_message($e->getMessage(), 'warning');
      return FALSE;
    }

    switch ($bundle) {
      case 'shp_distribution':
        // TODO: Handle updates.
        $name = $entity->getTitle();

        $data = [
          'build_image' => $entity->field_shp_builder_image->value,
          'secret' => $entity->field_shp_build_secret->value,
          'git' => [
            'uri' => $entity->field_shp_git_repository->value,
          ],
        ];

        $result = $orchestration_provider_plugin->updateDistribution($name, $data);
        if (!$result) {
          return FALSE;
        }
        break;

      case 'shp_environment':
        // TODO: Handle updates.
        break;
    }
  }
  return TRUE;
}

/**
 * Implements hook_ENTITY_TYPE_delete().
 */
function shp_orchestration_node_delete(EntityInterface $entity) {
  $bundle = $entity->bundle();

  if (strpos($bundle, 'shp') !== FALSE) {
    try {
      /** @var Drupal\shp_orchestration\OrchestrationProviderInterface $orchestration_provider_plugin */
      $orchestration_provider_plugin = \Drupal::service('plugin.manager.orchestration_provider')
        ->getProviderInstance();
    }
    catch (OrchestrationProviderNotConfiguredException $e) {
      drupal_set_message($e->getMessage(), 'warning');
      return FALSE;
    }

    switch ($entity->bundle()) {
      case 'shp_environment':
        $site = $entity->get('field_shp_site')
          ->first()
          ->get('entity')
          ->getTarget()
          ->getValue();

        if (isset($site->field_shp_distribution->target_id)) {
          $distribution = $site->get('field_shp_distribution')
            ->first()
            ->get('entity')
            ->getTarget()
            ->getValue();
        }
        if (!isset($distribution) || !isset($site)) {
          return FALSE;
        }

        $result = $orchestration_provider_plugin->deletedEnvironment(
          $distribution->title->value,
          $site->field_shp_short_name->value,
          $entity->id()
        );

        if (!$result) {
          return FALSE;
        }
        break;
    }
  }
  return TRUE;
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function shp_orchestration_form_node_form_alter(&$form, FormStateInterface $form_state) {
  $bundle = $form_state->getFormObject()->getEntity()->bundle();

  if ($bundle === 'shp_distribution') {
    // Add the validator.
    $form['#validate'][] = 'shp_orchestration_shp_distribution_form_validate';
  }
}

/**
 * Validates distribution form.
 *
 * @param array $form
 *   The form to be validated.
 * @param Drupal\Core\Form\FormStateInterface $form_state
 *   The form_state representing the form to be validated.
 */
function shp_orchestration_shp_distribution_form_validate(array $form, FormStateInterface $form_state) {
  // Verify that the secret exists in OpenShift.
  $secret_name = $form_state->getValue('field_shp_build_secret')[0]['value'];

  try {
    /** @var Drupal\shp_orchestration\OrchestrationProviderInterface $orchestration_provider_plugin */
    $orchestration_provider_plugin = \Drupal::service('plugin.manager.orchestration_provider')
      ->getProviderInstance();

    $response = $orchestration_provider_plugin->getSecret($secret_name);
    // The client will respond FALSE if the status code doesn't return a 200.
    if ($response === FALSE) {
      $form_state->setErrorByName('field_shp_build_secret', t('Secret: @secret_name does not exist.', ['@secret_name' => $secret_name]));
    }
  }
  catch (OrchestrationProviderNotConfiguredException $e) {
    drupal_set_message($e->getMessage(), 'warning');
  }
}
